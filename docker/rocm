# ~ ROCm on Ubuntu ~ #
FROM rocm/dev-ubuntu-24.04:6.3.3-complete
# Prevents Python from creating __pycache__/ and .pyc/ folders in the project
# folder
ENV PYTHONPYCACHEPREFIX=/.cache/python/
# Fixes mpi4py wheel building
ENV SETUPTOOLS_USE_DISTUTILS=local
# Install system packages
RUN apt update && apt install -y \
    # For git pip install
    git \
    # OpenMPI
    libopenmpi-dev \
    # UCX for InfiniBand
    libucx0 \
    # Python dev version to get header files for mpi4py + pip
    python3-dev \
    python3-pip \
    python-is-python3 \
    # Java to build our fork of Hydra
    default-jre \
    # Audio libraries
    ffmpeg \
    sox \
    libavdevice-dev \
    # Required by soundfile
    libffi8 \
    # Required for uv
    curl \
    # Clean up
    && rm -rf /var/lib/apt/lists/*
RUN ln -s /usr/bin/python /usr/bin/python
# Add the pyproject.toml and ai_repo folder to the container
ADD pyproject.toml /ai_repo/pyproject.toml
# Install Python dependencies
RUN pip install uv==0.7.3 --break-system-packages \
    && uv pip install --break-system-packages --system --no-cache-dir -e /ai_repo[rocm] --extra-index-url https://download.pytorch.org/whl/cu128  --index-strategy unsafe-best-match \
    && uv pip install --break-system-packages --system --no-cache-dir --no-build-isolation git+https://github.com/state-spaces/mamba.git@4a8a2a2ac9a1ed4aee2edb9207f41421ca11c5a4 git+https://github.com/Dao-AILab/causal-conv1d.git@e87a46b568fbb82a593c84a8a4e7e133fbbf2953
